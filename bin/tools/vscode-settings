#!/bin/sh
#------------------------------------------------------------------------------
# =========                 |
# \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox
#  \\    /   O peration     |
#   \\  /    A nd           | www.openfoam.com
#    \\/     M anipulation  |
#------------------------------------------------------------------------------
#     Copyright (C) 2020 OpenCFD Ltd.
#------------------------------------------------------------------------------
# License
#     This file is part of OpenFOAM, distributed under GPL-3.0-or-later.
#
# Script
#     bin/tools/vscode-settings
#
# Description
#     Emit some json content suitable for setting up Visual Studio Code
#     for use with OpenFOAM.
#
# Example
#     bin/tools/vscode-settings > .vscode/settings.json
#
# Environment
#     WM_PROJECT_DIR, WM_PROJECT_USER_DIR, WM_OPTIONS
#
# More information:
# https://openfoamwiki.net/index.php/HowTo_Use_OpenFOAM_with_Visual_Studio_Code
#     META-INFO/README.md for other routines that also use META-INFO.
#
#------------------------------------------------------------------------------
# Values consistent with wmake-with-bear
cacheDirName="build/$WM_OPTIONS"

printHelp() {
    cat<<USAGE

Usage: ${0##*/} [OPTIONS]

options:
    -help             Print the usage

Emit some json content suitable for setting up Visual Studio Code
for use with OpenFOAM.

For example,
    bin/tools/vscode-settings > .vscode/settings.json

USAGE
    exit 0  # clean exit
}


#------------------------------------------------------------------------------

unset outputDir

# Parse options
while [ "$#" -gt 0 ]
do
    case "$1" in
    -h | -help*)
        printHelp
        ;;
    *)
        echo "Unknown option/argument: '$1'" 1>&2
        break
        ;;
    esac
    shift
done


#------------------------------------------------------------------------------

if [ -z "$outputDir" ]
then
    prefixDir="$WM_PROJECT_DIR"
    if ! [ -w "$prefixDir" ]
    then
        echo "Non-writable directory: $prefixDir" 1>&2
        echo "Try with user location" 1>&2
        prefixDir="$WM_PROJECT_USER_DIR"

        if ! [ -w "$prefixDir" ]
        then
            echo "Non-writable directory: $prefixDir" 1>&2
            echo "Using home directory" 1>&2
            prefixDir="$HOME"
        fi
    fi
    outputDir="$prefixDir/$cacheDirName"
fi

## echo "Output = $outputDir" 1>&2

echo '{'
echo '    "C_Cpp.autocomplete": "Disabled",'
echo '    "C_Cpp.errorSquiggles": "Disabled",'
echo '    "C_Cpp.formatting": "Disabled",'
echo '    "C_Cpp.intelliSenseEngine": "Disabled"',
echo
echo '    "ccls.cache.directory": "'"$outputDir/ccls-cache"'",'
echo '    "ccls.misc.compilationDatabaseDirectory": "'"$outputDir"'"'
echo '}'

#------------------------------------------------------------------------------
